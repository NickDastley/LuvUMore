<article>
  <header class="center">
    <h1>LuvUMore</h1>
    <p class="winner">Heutiger Gewinner (<span class="date"><%= todayDate %></span>):
      <% if (winner) { %>
        <strong><%= winner === 'nico' ? names.a : names.b %></strong>
      <% } else { %>
        â€”
      <% } %>
    </p>
  </header>

  <form method="post" action="/today">
    <div class="big-buttons">
      <button type="submit" name="winner" value="nico" class="contrast"><%= names.a %></button>
      <button type="submit" name="winner" value="nena" class="secondary"><%= names.b %></button>
    </div>
  </form>

  <footer class="center">
    <small>TZ: <code><%= process.env.TZ || 'Europe/Berlin' %></code></small>
  </footer>
</article>

<!-- NEW: Relationship Duration Statistics -->
<article class="relationship-stats-card">
  <header>
    <h2>ðŸ’• Zusammen seit dem 12. November 2021</h2>
  </header>

  <div class="relationship-stats">
    <!-- Combined breakdown -->
    <div class="stat-box primary-stat">
      <div class="stat-label">Unsere gemeinsame Zeit</div>
      <div class="stat-value" id="timeCombined">
        <span id="years"><%= relationshipStats.breakdown.years %></span> Jahre,
        <span id="days"><%= relationshipStats.breakdown.days %></span> Tage,
        <span id="hours"><%= relationshipStats.breakdown.hours %></span> Stunden,
        <span id="minutes"><%= relationshipStats.breakdown.minutes %></span> Minuten,
        <span id="seconds"><%= relationshipStats.breakdown.seconds %></span> Sekunden
      </div>
    </div>

    <!-- Total units grid -->
    <div class="stats-grid">
      <div class="stat-box">
        <div class="stat-label">Tage</div>
        <div class="stat-value" id="totalDays"><%= relationshipStats.totals.days.toLocaleString('de-DE') %></div>
      </div>

      <div class="stat-box">
        <div class="stat-label">Stunden</div>
        <div class="stat-value" id="totalHours"><%= relationshipStats.totals.hours.toLocaleString('de-DE') %></div>
      </div>

      <div class="stat-box">
        <div class="stat-label">Minuten</div>
        <div class="stat-value" id="totalMinutes"><%= relationshipStats.totals.minutes.toLocaleString('de-DE') %></div>
      </div>

      <div class="stat-box">
        <div class="stat-label">Sekunden</div>
        <div class="stat-value" id="totalSeconds"><%= relationshipStats.totals.seconds.toLocaleString('de-DE') %></div>
      </div>
    </div>
  </div>

  <script>
    // Pass server data to client
    const RELATIONSHIP_START = '<%= relationshipStats.startDate %>';
    
    // Update function
    function updateRelationshipStats() {
      const start = new Date(RELATIONSHIP_START + 'T00:00:00');
      const now = new Date();
      const totalMs = now - start;
      
      // Calculate totals
      const totalSeconds = Math.floor(totalMs / 1000);
      const totalMinutes = Math.floor(totalSeconds / 60);
      const totalHours = Math.floor(totalMinutes / 60);
      const totalDays = Math.floor(totalHours / 24);
      
      // Calculate breakdown
      const years = Math.floor(totalDays / 365.25);
      const remainingDays = Math.floor(totalDays - (years * 365.25));
      const remainingHours = totalHours % 24;
      const remainingMinutes = totalMinutes % 60;
      const remainingSeconds = totalSeconds % 60;
      
      // Update DOM
      document.getElementById('years').textContent = years;
      document.getElementById('days').textContent = remainingDays;
      document.getElementById('hours').textContent = remainingHours;
      document.getElementById('minutes').textContent = remainingMinutes;
      document.getElementById('seconds').textContent = remainingSeconds;
      
      document.getElementById('totalDays').textContent = totalDays.toLocaleString('de-DE');
      document.getElementById('totalHours').textContent = totalHours.toLocaleString('de-DE');
      document.getElementById('totalMinutes').textContent = totalMinutes.toLocaleString('de-DE');
      document.getElementById('totalSeconds').textContent = totalSeconds.toLocaleString('de-DE');
    }
    
    // Update every second
    setInterval(updateRelationshipStats, 1000);
    
    // Initial update
    updateRelationshipStats();
  </script>
</article>

<article class="stats-card">
  <header>
    <h2>Statistiken</h2>
  </header>

  <div class="stats-summary">
    <% if (stats && stats.length > 0) { %>
      <p>
        <% stats.forEach((s, idx) => { %>
          <strong><%= s.winner === 'nico' ? names.a : names.b %></strong>: <%= s.count %> <%= s.count === 1 ? 'Sieg' : 'Siege' %><%= idx < stats.length - 1 ? ', ' : '' %>
        <% }); %>
      </p>
    <% } else { %>
      <p>Noch keine EintrÃ¤ge vorhanden.</p>
    <% } %>
  </div>

  <button type="button" id="toggleHistory" class="outline">Details anzeigen</button>

  <div id="historyTable" style="display: none; margin-top: 1rem;">
    <% if (history && history.length > 0) { %>
      <input type="text" id="filterDate" placeholder="Datum filtern..." style="margin-bottom: 0.5rem;" />
      <input type="text" id="filterWinner" placeholder="Gewinner filtern..." style="margin-bottom: 0.5rem;" />
      <input type="text" id="filterTime" placeholder="Uhrzeit filtern..." style="margin-bottom: 1rem;" />
      
      <table role="grid">
        <thead>
          <tr>
            <th data-sort="date" style="cursor: pointer;">Datum â–¼</th>
            <th data-sort="winner" style="cursor: pointer;">Gewinner</th>
            <th data-sort="time" style="cursor: pointer;">Uhrzeit</th>
          </tr>
        </thead>
        <tbody id="historyBody">
          <% history.forEach(entry => { %>
            <tr data-date="<%= entry.date %>" data-winner="<%= entry.winner %>" data-time="<%= new Date(entry.recordedAt).toLocaleTimeString('de-DE') %>">
              <td><%= entry.date %></td>
              <td><%= entry.winner === 'nico' ? names.a : names.b %></td>
              <td><%= new Date(entry.recordedAt).toLocaleTimeString('de-DE') %></td>
            </tr>
          <% }); %>
        </tbody>
      </table>
    <% } else { %>
      <p>Keine EintrÃ¤ge vorhanden.</p>
    <% } %>
  </div>
</article>
